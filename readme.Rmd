---
title: tradeR
date: "Last update: `r Sys.time()` in `r Sys.timezone()`"
output:
  html_document:
    df_print: kable
    toc: true
    toc_float: true
    code_folding: "hide"
    theme: united
    highlight: zenburn
---
```{r, read and extract}
# Read JSON files and extract the prices
library("rjson")

# Read any files on disk
files <- list.files(path = "tmp", pattern = "*.json", full.names = TRUE)
stopifnot(length(files) > 0)

# Extract the interesting bits
extract <- function(f){
    json <- fromJSON(file = f)
    sapply(json$Data, function(x) {
    mean(c(x$open, x$high, x$low))
  })
}

# Extract all series
prices <-as.data.frame(sapply(files, extract))

# Add a random series
random_prices <- cumsum(rnorm(nrow(prices)))
prices <- cbind(random_prices, prices)
# with(mtcars, boxplot(disp, mpg))
```

# Price alert!
If latest price is one standard deviation greater than the mean.

```{r, analysis}
library("pracma")

# Plot prices and ilnear regression
linear_regression <- function(name) {

  # Get prices for token
  y <- unlist(prices[name])
  x <- 1:length(y)

  # Calculate standard deviation
  # Report if latest value significantly exceeds mean
  standard_deviation <- sd(y)

  # Create plot title
  main_title <- sub("tmp/", "", sub(".json", "", name))

  if (tail(y, 1) > mean(y) + standard_deviation) {
    main_title <- paste(main_title, " - UP!")
  } else if (tail(y, 1) < mean(y) - standard_deviation) {
    main_title <- paste(main_title, " - DOWN!")
  }
  
  sub_title <- paste("sd", standard_deviation)

  # Fit line
  relation <- lm(y ~ x)

  # Plot with calculated line
  plot(y, type = "l", main = main_title, sub = sub_title, xlab = "minutes",
    ylab = "USD")

  # Add linear regression
  abline(relation, col = "orange")
  grid(10, 10)

  # Plot peaks
  peaks <- findpeaks(y, npeaks = 4, threshold=4, sortstr=TRUE)
  points(peaks[,2], peaks[,1], pch=4, col="red")

  # Histogram of diffs
  h <- diff(y)
  hist(h, breaks=500, main = paste("hist", main_title), sub = paste("std
    dev", standard_deviation))
}

plots <- sapply(colnames(prices), linear_regression)
```

```{bash, revision info}
git log --oneline -n 1
```
